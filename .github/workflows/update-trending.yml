name: Update Trending Data

on:
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-trending:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Query Analytics Engine and generate trending.js
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: "95bdaad9a0525e9a9af474a004504732"
        run: |
          python3 - <<'PYEOF'
          import json
          import urllib.request
          import urllib.error
          import os
          import sys

          account_id = os.environ["CF_ACCOUNT_ID"]
          api_token = os.environ["CF_API_TOKEN"]

          sql = """SELECT blob2 AS name,
            SUM(IF(blob1 = 'view', 1, 0)) AS views,
            SUM(IF(blob1 != 'view' AND blob1 != 'test', 1, 0)) AS intents
            FROM sbburgerweek
            WHERE timestamp >= toDateTime('2026-02-19 08:00:00')
            GROUP BY blob2
            ORDER BY intents DESC
            LIMIT 500"""

          url = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/analytics_engine/sql"
          req = urllib.request.Request(url, data=sql.encode(), method="POST")
          req.add_header("Authorization", f"Bearer {api_token}")
          req.add_header("Content-Type", "text/plain")

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read())
          except urllib.error.URLError as e:
              print(f"API request failed: {e}", file=sys.stderr)
              sys.exit(1)

          result = {}
          if "data" in data:
              for row in data["data"]:
                  name = row.get("name", "")
                  if name:
                      result[name] = {
                          "views": int(row.get("views", 0)),
                          "intents": int(row.get("intents", 0)),
                      }

          js = "// trending.js â€” auto-generated by GitHub Action, do not edit manually\n"
          js += "const TRENDING = " + json.dumps(result, indent=2) + ";\n"

          with open("trending.js", "w") as f:
              f.write(js)

          print(f"Generated trending.js with {len(result)} restaurants")
          PYEOF

      - name: Commit if changed
        run: |
          git diff --quiet trending.js && exit 0
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add trending.js
          git stash
          git pull --rebase
          git stash pop
          git add trending.js
          git commit -m "Update trending data [skip ci]"
          git push
